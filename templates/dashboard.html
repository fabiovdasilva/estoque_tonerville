{% extends "base.html" %}

{% block content %}
<style>
    /* --- PADRÃO VISUAL (Segoe UI + Uppercase) --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    .page-title { 
        color: #2C3E50 !important; 
        font-weight: 700; 
        margin-bottom: 5px; 
    }
    
    /* Cards Topo */
    .card-dashboard { border: none; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); color: white; transition: transform 0.2s; position: relative; overflow: hidden; }
    .card-dashboard.clickable { cursor: pointer; }
    .card-dashboard.clickable:hover { transform: translateY(-3px); }
    .card-dashboard h3 { font-weight: 700; font-size: 2.2rem; margin: 0; }
    .card-dashboard small { text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; opacity: 0.95; }
    
    /* Gradientes */
    .bg-gradient-primary { background: linear-gradient(135deg, #2980b9, #2c3e50); }
    .bg-gradient-success { background: linear-gradient(135deg, #27ae60, #16a085); }
    .bg-gradient-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .bg-gradient-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

    /* Cards de Conteúdo e Tabelas */
    .card-content { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border-radius: 8px; height: 100%; display: flex; flex-direction: column; }
    .card-header-clean { background-color: white; border-bottom: 1px solid #f0f0f0; padding: 15px 20px; font-weight: 700; color: #2C3E50; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; flex-shrink: 0; }
    
    /* --- TABELA COM SCROLL (NOVO) --- */
    /* Define altura fixa para exibir +- 5 linhas (aprox 280px) e scroll */
    .table-scroll-container {
        max-height: 280px; /* Altura para ~5 linhas */
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    /* Estilização da Barra de Rolagem (Fina e Discreta) */
    .table-scroll-container::-webkit-scrollbar { width: 6px; }
    .table-scroll-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .table-scroll-container::-webkit-scrollbar-thumb { background: #d1d1d1; border-radius: 4px; }
    .table-scroll-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

    /* Fixar Cabeçalho da Tabela ao Rolar (Opcional, mas recomendado) */
    .table thead th { 
        position: sticky; 
        top: 0; 
        z-index: 1; 
        background-color: white; /* Fundo branco para cobrir o conteúdo ao rolar */
        box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1); /* Sombra sutil para separar */
        color: #6c757d; 
        font-weight: 700; 
        font-size: 0.8rem; 
        border-bottom: 2px solid #f0f0f0; 
        border-top: none; 
        padding: 12px 15px;
        text-transform: uppercase; 
        letter-spacing: 0.5px;
    }
    
    .table tbody td { 
        vertical-align: middle; 
        color: #2c3e50; 
        font-size: 0.95rem; 
        padding: 12px 15px; 
        border-bottom: 1px solid #f8f9fa;
    }
    .table-hover tbody tr:hover { background-color: #fcfcfc; }

    /* ESTILO VISUAL ANEXO (Borda Lateral Colorida) */
    .row-alert-red { background-color: #fff5f5 !important; border-left: 5px solid #e74c3c !important; }
    .row-alert-orange { background-color: #fff8e1 !important; border-left: 5px solid #f39c12 !important; }
    .row-alert-red td:first-child, .row-alert-orange td:first-child { padding-left: 15px; }

    /* Badges de Tipo */
    .badge-tipo { padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; color: white; border: none; text-transform: uppercase; }
    .badge-venda { background-color: #27ae60; }   
    .badge-locacao { background-color: #2980b9; } 
    .badge-entrada { background-color: #2c3e50; } 
    .badge-ajuste { background-color: #f39c12; color: #333; }
    
    .badge-critico { background-color: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
    .badge-baixo { background-color: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
</style>

<div id="dashboard-page" class="page-content active">
    <div class="page-header mb-4">
        <h1 class="page-title">Dashboard</h1>
        <p class="text-muted small">Visão geral do sistema</p>
    </div>
    
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-primary p-3 clickable" onclick="window.location.href='{{ url_for('estoque') }}'">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ total_itens }}</h3><small>Estoque Total</small></div>
                    <i class="fas fa-boxes fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-success p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ saidas_mes }}</h3><small>Saídas (Mês)</small></div>
                    <i class="fas fa-dolly fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-purple p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ total_contratos }}</h3><small>Contratos Ativos</small></div>
                    <i class="fas fa-file-contract fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-warning p-3 clickable" onclick="window.location.href='{{ url_for('notificacoes') }}'">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ total_alertas }}</h3><small>Alertas Pendentes</small></div>
                    <i class="fas fa-bell fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        
        <div class="col-lg-6">
            <div class="card card-content">
                <div class="card-header-clean">
                    <span>ESTOQUE BAIXO</span>
                    <span class="badge bg-warning text-dark">{{ itens_atencao|length }} itens</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-scroll-container">
                        <table class="table mb-0">
                            <thead><tr><th class="ps-3">PRODUTO</th><th>MARCA</th><th>TIPO</th><th>ATUAL</th><th>MÍN</th><th>STATUS</th></tr></thead>
                            <tbody>
                                {% for item in itens_atencao %}
                                    <tr class="{{ item.row_class }}">
                                        <td class="ps-3 fw-bold">{{ item.produto.nome }}</td>
                                        <td>{{ item.produto.marca }}</td>
                                        <td>{{ item.produto.categoria }}</td>
                                        <td class="fw-bold">{{ item.produto.quantidade }}</td>
                                        <td class="text-muted">{{ item.produto.minimo }}</td>
                                        <td>
                                            {% if item.status == 'Crítico' %}
                                                <span class="badge-critico">CRÍTICO</span>
                                            {% else %}
                                                <span class="badge-baixo">BAIXO</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="6" class="text-center p-4 text-success"><i class="fas fa-check-circle me-2"></i> Estoque saudável.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card card-content">
                <div class="card-header-clean">
                    <span>VENCIMENTOS PRÓXIMOS</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-scroll-container">
                        <table class="table mb-0">
                            <thead><tr><th class="ps-3">CLIENTE</th><th>VENCIMENTO</th><th>VALOR</th><th>STATUS</th></tr></thead>
                            <tbody>
                                {% for venda in vendas_vencendo %}
                                    {% set dias = (hoje.date() - venda.data_vencimento).days %}
                                    <tr class="{% if dias > 0 %}row-alert-red{% else %}row-alert-orange{% endif %}">
                                        <td class="ps-3 fw-bold">{{ venda.cliente.nome }}</td>
                                        <td>{{ venda.data_vencimento.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ venda.valor_total | currency }}</td>
                                        <td>
                                            {% if dias > 0 %}
                                                <span class="text-danger fw-bold small">ATRASADO {{ dias }}D</span>
                                            {% else %}
                                                <span class="text-warning fw-bold small">VENCE HOJE</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="4" class="text-center p-4 text-success"><i class="fas fa-check-circle me-2"></i> Tudo em dia.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-6">
            <div class="card card-content">
                <div class="card-header-clean">
                    <span><i class="fas fa-arrow-down text-primary me-2"></i> ÚLTIMAS ENTRADAS</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-scroll-container">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th class="ps-3">DATA</th>
                                    <th>MARCA</th>      <th>CATEGORIA</th>  <th>PRODUTO</th>
                                    <th class="text-center">QTD</th>
                                    <th>FORNECEDOR</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mov in ultimas_entradas %}
                                <tr>
                                    <td class="ps-3 text-muted">{{ mov.data.strftime('%d/%m') }}</td>
                                    <td class="small">{{ mov.produto.marca }}</td>      <td class="small">{{ mov.produto.categoria }}</td>  <td>
                                        <span class="fw-bold text-dark">{{ mov.produto.nome }}</span>
                                        {% if mov.valor_unitario_entrada > 0 %}
                                        <div class="small text-success">{{ mov.valor_unitario_entrada | currency }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center"><span class="badge bg-light text-primary border border-primary">+{{ mov.quantidade }}</span></td>
                                    <td class="text-muted small">{{ mov.destino_origem }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="text-center p-4 text-muted">Sem entradas recentes.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card card-content">
                <div class="card-header-clean">
                    <span><i class="fas fa-arrow-up text-warning me-2"></i> ÚLTIMAS SAÍDAS</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-scroll-container">
                        <table class="table mb-0">
                            <thead><tr><th class="ps-3">DATA</th><th>TIPO</th><th>PRODUTO</th><th>QTD</th><th>DESTINO</th></tr></thead>
                            <tbody>
                                {% for mov in ultimas_saidas %}
                                <tr>
                                    <td class="ps-3 text-muted">{{ mov.data.strftime('%d/%m') }}</td>
                                    <td>
                                        {% if mov.tipo == 'Venda' %}
                                            <span class="badge-tipo badge-venda">VENDA</span>
                                        {% elif mov.tipo == 'Saida_Locacao' %}
                                            <span class="badge-tipo badge-locacao">LOCAÇÃO</span>
                                        {% else %}
                                            <span class="badge-tipo badge-ajuste">AJUSTE</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="fw-bold text-dark">{{ mov.produto.nome }}</span></td>
                                    <td class="text-danger fw-bold">-{{ mov.quantidade }}</td>
                                    <td class="text-muted small">{{ mov.destino_origem }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="5" class="text-center p-4 text-muted">Sem saídas recentes.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}