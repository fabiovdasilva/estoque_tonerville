{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .dashboard-container { font-family: 'Inter', sans-serif; }

    /* --- CARDS KPI --- */
    .stat-card {
        background-color: var(--card-bg) !important; 
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }

    /* AQUI ESTÁ A CORREÇÃO: Usa a variável do tema (Preto no light, Cinza no dark) */
    .stat-value { 
        font-size: 1.8rem; 
        font-weight: 700; 
        color: var(--text-main) !important; 
    }
    .stat-label { 
        font-size: 0.85rem; 
        color: var(--text-muted) !important; 
        font-weight: 500; 
    }
    
    .stat-icon {
        width: 48px; height: 48px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; margin-bottom: 16px;
    }
    .icon-blue { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .icon-green { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .icon-orange { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .icon-purple { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }

    /* --- CONTEÚDO --- */
    .content-card {
        background-color: var(--card-bg) !important;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        height: 100%;
        display: flex; flex-direction: column;
        color: var(--text-main);
    }
    
    .card-header-custom {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
    }
    .card-title-custom { 
        font-size: 1rem; 
        font-weight: 700; 
        color: var(--text-main) !important; /* Usa a variável dinâmica */
        margin: 0; 
    }
    
    /* Tabelas */
    .table-sm-custom th { 
        font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted) !important; 
        border-bottom: 1px solid var(--border-color); font-weight: 600; padding-bottom: 8px;
        background: transparent !important;
    }
    .table-sm-custom td { 
        padding: 10px 4px; vertical-align: middle; 
        border-bottom: 1px solid var(--border-color); color: var(--text-main) !important;
        background: transparent !important;
    }
    .table-sm-custom tr:last-child td { border-bottom: none; }
    .text-truncate { color: var(--text-main) !important; }

    /* Badges */
    .badge-status { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
    .bg-soft-green { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .bg-soft-red { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .bg-soft-blue { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .bg-soft-warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    
    .btn-link { color: var(--primary-color); }
</style>


<div class="dashboard-container">
    
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="text-muted small mb-0">Visão Geral Operacional</p>
        </div>
        <div>
            <span class="text-muted small fw-bold"><i class="far fa-calendar-alt me-1"></i> {{ hoje }}</span>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-6 col-lg-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between">
                    <div><div class="stat-label">Vendas Mês</div><div class="stat-value">{{ total_vendas_mes | default(0) | currency }}</div></div>
                    <div class="stat-icon icon-green"><i class="fas fa-dollar-sign"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between">
                    <div><div class="stat-label">Contratos Ativos</div><div class="stat-value">{{ total_contratos_ativos | default(0) }}</div></div>
                    <div class="stat-icon icon-blue"><i class="fas fa-file-contract"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between">
                    <div><div class="stat-label">Alerta Estoque</div><div class="stat-value">{{ total_itens_alerta | default(0) }}</div></div>
                    <div class="stat-icon icon-orange"><i class="fas fa-boxes"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="stat-card">
                <div class="d-flex justify-content-between">
                    <div><div class="stat-label">Pendências</div><div class="stat-value">{{ total_alertas | default(0) }}</div></div>
                    <div class="stat-icon icon-purple"><i class="fas fa-bell"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="content-card">
                <div class="card-header-custom">
                    <h5 class="card-title-custom">Fluxo Financeiro (6 Meses)</h5>
                </div>
                <div style="height: 250px;">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="content-card">
                <div class="card-header-custom">
                    <h5 class="card-title-custom">Status do Parque (Impressoras)</h5>
                </div>
                <div style="height: 200px; display: flex; justify-content: center;">
                    <canvas id="impressorasChart"></canvas>
                </div>
                <div class="mt-3 text-center small text-muted">
                    Total: {{ status_impressoras.Disponivel + status_impressoras.Locada + status_impressoras.Manutencao }} Máquinas
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="content-card">
                <div class="card-header-custom">
                    <h5 class="card-title-custom text-danger"><i class="far fa-clock me-2"></i>Vencimentos Próximos</h5>
                    <a href="{{ url_for('vendas') }}" class="btn btn-sm btn-link text-decoration-none p-0">Ver todos</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm-custom mb-0">
                        <thead><tr><th>Cliente</th><th>Vencimento</th><th class="text-end">Valor</th></tr></thead>
                        <tbody>
                            {% for v in lista_vencimentos %}
                            <tr>
                                <td class="text-truncate" style="max-width: 120px;" title="{{ v.cliente.nome }}">{{ v.cliente.nome }}</td>
                                <td>
                                    {% if v.data_vencimento < hoje_obj %}
                                        <span class="text-danger fw-bold">{{ v.data_vencimento.strftime('%d/%m') }}</span>
                                    {% else %}
                                        {{ v.data_vencimento.strftime('%d/%m') }}
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold">{{ v.valor_total | currency }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center text-muted py-3">Sem pendências próximas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="content-card">
                <div class="card-header-custom">
                    <h5 class="card-title-custom text-primary"><i class="fas fa-boxes me-2"></i>Movimentação Estoque</h5>
                    <a href="{{ url_for('estoque') }}" class="btn btn-sm btn-link text-decoration-none p-0">Ver Estoque</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm-custom mb-0">
                        <thead><tr><th>Item</th><th>Tipo</th><th class="text-end">Qtd</th></tr></thead>
                        <tbody>
                            {% for mov in lista_mov_estoque %}
                            <tr>
                                <td class="text-truncate" style="max-width: 120px;" title="{{ mov.produto.nome }}">{{ mov.produto.nome }}</td>
                                <td>
                                    {% if mov.tipo == 'Entrada' %}
                                        <span class="badge-status bg-soft-green">ENTRADA</span>
                                    {% elif mov.tipo in ['Venda', 'Saida_Locacao'] %}
                                        <span class="badge-status bg-soft-red">SAÍDA</span>
                                    {% else %}
                                        <span class="badge-status bg-soft-warning">AJUSTE</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold">{{ mov.quantidade }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center text-muted py-3">Sem movimentações.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="content-card">
                <div class="card-header-custom">
                    <h5 class="card-title-custom text-info"><i class="fas fa-print me-2"></i>Mov. Impressoras</h5>
                    <a href="{{ url_for('impressoras') }}" class="btn btn-sm btn-link text-decoration-none p-0">Ver Parque</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm-custom mb-0">
                        <thead><tr><th>Modelo</th><th>De &rarr; Para</th><th>Data</th></tr></thead>
                        <tbody>
                            {% for mov in lista_mov_impressoras %}
                            <tr>
                                <td class="text-truncate" style="max-width: 100px;">{{ mov.impressora.modelo }}</td>
                                <td class="small text-muted">
                                    {{ mov.origem }} &rarr; <strong>{{ mov.destino }}</strong>
                                </td>
                                <td class="text-end text-muted small">{{ mov.data.strftime('%d/%m') }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center text-muted py-3">Sem movimentações de máquinas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- GRÁFICO FINANCEIRO (BARRAS) ---
    const ctxFin = document.getElementById('financeChart').getContext('2d');
    new Chart(ctxFin, {
        type: 'bar',
        data: {
            labels: {{ grafico_labels | tojson }},
            datasets: [
                { label: 'Entradas', data: {{ grafico_receitas | tojson }}, backgroundColor: '#10b981', borderRadius: 4 },
                { label: 'Saídas', data: {{ grafico_despesas | tojson }}, backgroundColor: '#ef4444', borderRadius: 4 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true, grid: { display: true, color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } }
        }
    });

    // --- GRÁFICO IMPRESSORAS (PIZZA) ---
    const ctxImp = document.getElementById('impressorasChart').getContext('2d');
    new Chart(ctxImp, {
        type: 'doughnut',
        data: {
            labels: ['Disponível', 'Locada/Cliente', 'Manutenção'],
            datasets: [{
                data: [
                    {{ status_impressoras.Disponivel }},
                    {{ status_impressoras.Locada }},
                    {{ status_impressoras.Manutencao }}
                ],
                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'],
                borderWidth: 0,
                cutout: '65%'
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } }
        }
    });
</script>
{% endblock %}