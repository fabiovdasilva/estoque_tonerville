{% extends "base.html" %}

{% block content %}
<style>
    /* --- DESIGN GERAL (Mantendo identidade visual) --- */
    .page-title { 
        color: #2C3E50 !important; 
        font-family: 'Segoe UI', sans-serif; 
        font-weight: 700; 
        margin-bottom: 5px; 
    }
    
    /* Cards do Topo (Indicadores) */
    .card-overview { border: none; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); color: white; padding: 20px; transition: transform 0.2s; position: relative; overflow: hidden; height: 100%; }
    .card-overview:hover { transform: translateY(-3px); }
    .card-overview h3 { font-weight: 700; font-size: 2.2rem; margin: 0; }
    .card-overview small { text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; opacity: 0.95; font-weight: 600; }
    
    .bg-gradient-primary { background: linear-gradient(135deg, #2980b9, #2c3e50); }
    .bg-gradient-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-gradient-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); }

    /* --- NOVO DESIGN DO CARD DE CONTRATO (Customizado) --- */
    .contrato-card { 
        border: none; 
        border-radius: 10px; 
        background: white; 
        box-shadow: 0 3px 10px rgba(0,0,0,0.05); 
        margin-bottom: 15px; 
        transition: all 0.3s; 
        cursor: pointer; 
        position: relative;
        border-left: 5px solid #ccc; /* Cor padrão, será sobrescrita */
        overflow: hidden;
    }
    .contrato-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0,0,0,0.12); 
    }
    
    /* Borda lateral por Classificação */
    .border-class-A { border-left-color: #27ae60 !important; }
    .border-class-B { border-left-color: #f39c12 !important; }
    .border-class-C { border-left-color: #e74c3c !important; }
    
    /* Labels Internos */
    .info-label { font-size: 0.65rem; text-transform: uppercase; color: #95a5a6; font-weight: 700; display: block; margin-bottom: 2px; }
    .info-value { font-size: 0.85rem; font-weight: 600; color: #2c3e50; }
    .info-value-big { font-size: 1rem; font-weight: 700; color: #27ae60; }

    /* Status Badge */
    .badge-status-card { font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 700; }
    .bg-status-ativo { background-color: #e8f8f5; color: #27ae60; border: 1px solid rgba(39, 174, 96, 0.2); }
    .bg-status-cancelado { background-color: #fdedec; color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.2); }

    /* Ícone Detalhes */
    .btn-detalhes-icon { 
        width: 30px; height: 30px; 
        background-color: #f8f9fa; color: #2980b9; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        transition: all 0.2s;
    }
    .contrato-card:hover .btn-detalhes-icon { background-color: #2980b9; color: white; }

    /* Tabs */
    .nav-tabs { border-bottom: 1px solid #eee; margin-bottom: 20px; }
    .nav-tabs .nav-link { color: #95a5a6; font-weight: 600; border: none; border-bottom: 3px solid transparent; padding: 12px 20px; }
    .nav-tabs .nav-link:hover { color: #34495e; }
    .nav-tabs .nav-link.active { color: #2c3e50; background: transparent; border-bottom-color: #3498db; }
    
    /* Timeline Modal */
    .timeline-item { position: relative; padding-left: 30px; border-left: 2px solid #e9ecef; padding-bottom: 20px; }
    .timeline-item::after { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: #fff; border: 2px solid #007bff; }
    .timeline-date { font-size: 0.75rem; color: #adb5bd; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; display: block; }
</style>

<div id="contratos-page" class="page-content active">
    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title">Contratos de Locação</h1>
            <p class="text-muted mb-0">Gestão de vigências e franquias</p>
        </div>
        <button class="btn btn-primary shadow-sm" onclick="abrirModalNovo()">
            <i class="fas fa-plus me-2"></i> Novo Contrato
        </button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card card-overview bg-gradient-primary">
                <div class="d-flex justify-content-between align-items-center h-100">
                    <div><h3>{{ total_ativos }}</h3><small>Contratos Ativos</small></div>
                    <i class="fas fa-file-contract fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-overview bg-gradient-success">
                <div class="d-flex justify-content-between align-items-center h-100">
                    <div><h3>{{ valor_total_mensal | currency }}</h3><small>Receita Mensal Fixa</small></div>
                    <i class="fas fa-dollar-sign fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-overview bg-gradient-warning">
                <div class="d-flex justify-content-between align-items-center h-100">
                    <div><h3>{{ impressoras_locadas }}</h3><small>Máquinas Locadas</small></div>
                    <i class="fas fa-print fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="contratoDetalhe" class="card shadow border-0 mb-4" style="display: none;">
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-file-signature me-2 text-primary"></i> Detalhes: <span id="det_numero" class="text-secondary"></span></h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="fecharDetalhes()">Voltar</button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h3 id="det_cliente" class="fw-bold text-dark mb-4"></h3>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <small class="text-uppercase text-muted fw-bold d-block mb-1">Status</small>
                            <div id="det_status"></div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-uppercase text-muted fw-bold d-block mb-1">Vigência</small>
                            <div id="det_vigencia" class="fw-bold text-dark"></div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-uppercase text-muted fw-bold d-block mb-1">Mensalidade Total</small>
                            <div id="det_valor" class="text-success fw-bold fs-5"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-light rounded border">
                        <div class="d-flex align-items-center">
                            <div class="me-3 text-primary"><i class="fas fa-cubes fa-2x"></i></div>
                            <div>
                                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Configuração de Pool Global</small>
                                <div id="det_pool_global" class="fw-bold text-dark fs-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 ps-md-5 border-start">
                    <label class="small text-muted fw-bold mb-3 d-block">GERENCIAMENTO</label>
                    <div class="d-grid gap-2">
                        <a id="btn_pdf" href="#" target="_blank" class="btn btn-outline-danger text-start"><i class="fas fa-file-pdf me-2"></i> Visualizar Contrato PDF</a>
                        <button class="btn btn-outline-primary text-start" onclick="abrirModalEditar()"><i class="fas fa-edit me-2"></i> Editar Informações</button>
                        <button id="btn_cancelar_modal" class="btn btn-outline-secondary text-start" onclick="abrirModalCancelar()"><i class="fas fa-ban me-2"></i> Cancelar Contrato</button>
                    </div>
                </div>
            </div>
            <h6 class="mt-5 mb-3 fw-bold text-secondary text-uppercase small border-bottom pb-2"><i class="fas fa-print me-2"></i> Impressoras Vinculadas</h6>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small">
                        <tr>
                            <th class="ps-3 border-0">MODELO / SERIAL</th>
                            <th class="border-0">TIPO FRANQUIA</th>
                            <th class="border-0">DETALHES FRANQUIA</th>
                            <th class="text-end border-0">VALOR LOCAÇÃO</th>
                            <th class="border-0" width="50">HISTÓRICO</th>
                        </tr>
                    </thead>
                    <tbody id="det_lista_imp" class="border-top-0"></tbody>
                </table>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="myTab">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabAtivos">Ativos</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabCancelados">Cancelados</a></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tabAtivos">
            <div class="row g-3">
                {% for c in contratos_ativos %}
                <div class="col-md-4">
                    <div class="card contrato-card border-class-{{ c.classificacao_abc }} h-100" onclick="verDetalhes('{{ c.id }}')">
                        <div class="card-body p-3 d-flex flex-column">
                            
                            <div class="mb-3">
                                <h5 class="fw-bold text-dark mb-0 text-truncate" title="{{ c.cliente.nome }}">{{ c.cliente.nome }}</h5>
                                <small class="text-muted fw-bold">Contrato: {{ c.numero_contrato }}</small>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <span class="info-label">Mensalidade</span>
                                    <span class="info-value-big">{{ c.valor_mensal_total | currency }}</span>
                                </div>
                                <div class="col-6 text-end">
                                    <span class="info-label">Status</span>
                                    <span class="badge-status-card bg-status-ativo">{{ c.status }}</span>
                                </div>
                                <div class="col-6 mt-2">
                                    <span class="info-label">Impressoras</span>
                                    <span class="info-value"><i class="fas fa-print me-1 text-muted"></i> {{ c.itens|length }} Und</span>
                                </div>
                                <div class="col-6 mt-2 text-end">
                                    <span class="info-label">Fechamento</span>
                                    <span class="info-value">Dia {{ c.dia_vencimento }}</span>
                                </div>
                            </div>

                            <div class="mt-auto pt-2 border-top d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="info-label" style="color: #e74c3c;">Vencimento Contrato</span>
                                    <span class="fw-bold text-dark small">{{ c.data_fim.strftime('%d/%m/%Y') }}</span>
                                </div>
                                <div class="btn-detalhes-icon">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center py-5 text-muted">
                    <i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i>
                    <p>Nenhum contrato ativo encontrado.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="tabCancelados">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light small text-muted">
                                <tr>
                                    <th class="ps-4 border-0">CLIENTE</th>
                                    <th class="border-0">Nº CONTRATO</th>
                                    <th class="border-0">CANCELADO EM</th>
                                    <th class="border-0">JUSTIFICATIVA</th>
                                    <th class="pe-4 text-end border-0">AÇÃO</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in contratos_cancelados %}
                                <tr>
                                    <td class="ps-4 fw-bold text-dark">{{ c.cliente.nome }}</td>
                                    <td>{{ c.numero_contrato }}</td>
                                    <td>{{ c.data_fim.strftime('%d/%m/%Y') }}</td>
                                    <td><small class="text-muted fst-italic">{{ c.justificativa_cancelamento }}</small></td>
                                    <td class="pe-4 text-end">
                                        <a href="{{ url_for('reativar_contrato', id=c.id) }}" class="btn btn-sm btn-outline-success rounded-pill px-3 fw-bold" onclick="return confirm('Deseja reativar este contrato?')">
                                            <i class="fas fa-undo me-1"></i> Reativar
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="5" class="text-center py-5 text-muted">Nenhum contrato cancelado.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalContrato" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <form id="formContrato" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="contrato_id" id="form_contrato_id">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Novo Contrato</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <h6 class="text-primary fw-bold mb-3 border-bottom pb-2 text-uppercase" style="font-size: 0.8rem;">1. Dados Gerais & Pool Global</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">Cliente</label>
                                    <select class="form-select border-0 shadow-sm" name="cliente_id" id="form_cliente" required>
                                        <option value="">Selecione...</option>
                                        {% for cl in clientes %}
                                        <option value="{{ cl.id }}">{{ cl.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4"><label class="form-label small fw-bold text-muted">Nº Contrato</label><input type="text" class="form-control border-0 shadow-sm" name="numero_contrato" id="form_numero" required></div>
                                <div class="col-md-4"><label class="form-label small fw-bold text-muted">PDF Assinado</label><input type="file" class="form-control border-0 shadow-sm" name="arquivo_contrato" accept=".pdf"></div>
                                
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">Início</label><input type="date" class="form-control border-0 shadow-sm" name="data_inicio" id="form_inicio" required></div>
                                <div class="col-md-3"><label class="form-label small fw-bold text-muted">Fim</label><input type="date" class="form-control border-0 shadow-sm" name="data_fim" id="form_fim" required></div>
                                
                                <div class="col-md-3 border-start ps-4">
                                    <label class="form-label small fw-bold text-primary">Pool Global (Páginas)</label>
                                    <input type="number" class="form-control border-primary" name="franquia_global_qtde" id="form_pool" placeholder="Opcional">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-primary">Excedente Global (R$)</label>
                                    <input type="text" class="form-control border-primary" name="valor_excedente_global" id="form_exc_pool" placeholder="0,00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-white">
                                <h6 class="text-primary fw-bold mb-0 text-uppercase" style="font-size: 0.8rem;">2. Impressoras Vinculadas</h6>
                                <button type="button" class="btn btn-sm btn-success px-3 rounded-pill shadow-sm" onclick="addLinhaImpressora()"><i class="fas fa-plus me-1"></i> Adicionar Máquina</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered mb-0">
                                    <thead class="bg-light small text-muted">
                                        <tr>
                                            <th style="width: 35%;">IMPRESSORA</th>
                                            <th style="width: 15%;">TIPO FRANQUIA</th>
                                            <th style="width: 15%;">FRANQUIA IND.</th>
                                            <th style="width: 15%;">EXCEDENTE IND.</th>
                                            <th style="width: 15%;">LOCAÇÃO (R$)</th>
                                            <th style="width: 5%;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyImp"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-light">
                    <button type="submit" class="btn btn-primary px-4 rounded-pill fw-bold shadow-sm">Salvar Contrato</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCancelar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <form action="{{ url_for('cancelar_contrato_route') }}" method="POST">
                <input type="hidden" name="contrato_id" id="cancel_id">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title">Cancelar Contrato</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 text-warning-emphasis">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Todas as impressoras vinculadas voltarão para o status <strong>Disponível</strong> no Estoque.
                    </div>
                    <label class="form-label fw-bold">Motivo do Cancelamento:</label>
                    <textarea class="form-control bg-light border-0" name="justificativa" rows="3" required placeholder="Digite o motivo..."></textarea>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-danger px-4 rounded-pill">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistoricoImpressora" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0">
            <div class="modal-header bg-white border-bottom-0">
                <div>
                    <h5 class="modal-title fw-bold text-dark mb-0" id="hist_titulo">Histórico</h5>
                    <small class="text-muted" id="hist_subtitulo">S/N: -</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <ul class="nav nav-tabs nav-tabs-sm mb-3" id="tabHistImp">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabMovs">Movimentações</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabManut">Manutenções</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tabMovs">
                        <div class="card border-0 shadow-sm"><div class="card-body p-0"><div id="listaMovimentacoes" class="p-4">Carregando...</div></div></div>
                    </div>
                    <div class="tab-pane fade" id="tabManut">
                        <div class="accordion accordion-flush" id="accordionManutencoes"></div>
                        <div id="msgSemManut" class="text-center text-muted py-4" style="display:none;">Nenhuma manutenção registrada.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const impressorasData = [
        {% for imp in impressoras_todas %}
        { id: "{{ imp.id }}", nome: "{{ imp.modelo }} - {{ imp.serial }}", status: "{{ imp.status }}", loc: "{{ imp.localizacao }}" },
        {% endfor %}
    ];

    let contratoAtualId = null;
    var modalHistImp = null;

    document.addEventListener("DOMContentLoaded", function() {
        modalHistImp = new bootstrap.Modal(document.getElementById('modalHistoricoImpressora'));
    });

    function addLinhaImpressora(data = null) {
        const tbody = document.getElementById('tbodyImp');
        const tr = document.createElement('tr');
        
        let options = '<option value="">Selecione...</option>';
        impressorasData.forEach(imp => {
            let label = imp.nome;
            let style = "";
            if(imp.status === 'Disponível') { label += " (Estoque)"; } 
            else { label += ` (No Cliente: ${imp.loc})`; style = "color: #d35400; font-weight: bold;"; }
            let selected = (data && data.id == imp.id) ? 'selected' : '';
            options += `<option value="${imp.id}" style="${style}" ${selected}>${label}</option>`;
        });

        tr.innerHTML = `
            <td class="p-2"><select class="form-select form-select-sm border-0 bg-light" name="impressora_id[]" required>${options}</select></td>
            <td class="p-2">
                <select class="form-select form-select-sm border-0 bg-light" name="tipo_franquia_item[]" onchange="toggleInputs(this)">
                    <option value="Individual" ${data && data.tipo_franquia === 'Individual' ? 'selected' : ''}>Individual</option>
                    <option value="Global" ${data && data.tipo_franquia === 'Global' ? 'selected' : ''}>Usa Pool Global</option>
                </select>
            </td>
            <td class="p-2"><input type="number" class="form-control form-select-sm border-0 bg-light inp-ind" name="franquia_individual[]" value="${data ? data.franquia_val : ''}" placeholder="0"></td>
            <td class="p-2"><input type="text" class="form-control form-select-sm border-0 bg-light inp-ind" name="excedente_individual[]" value="${data ? data.excedente_val : ''}" placeholder="0,00"></td>
            <td class="p-2"><input type="text" class="form-control form-select-sm border-0 bg-light" name="valor_locacao[]" value="${data ? data.valor : ''}" required></td>
            <td class="p-2 text-center"><button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove()"><i class="fas fa-times"></i></button></td>
        `;
        tbody.appendChild(tr);
        toggleInputs(tr.querySelector('select[name="tipo_franquia_item[]"]'));
    }

    function toggleInputs(select) {
        const tr = select.closest('tr');
        const inputs = tr.querySelectorAll('.inp-ind');
        const isGlobal = select.value === 'Global';
        inputs.forEach(inp => {
            inp.disabled = isGlobal;
            if(isGlobal) { inp.value = ""; inp.style.opacity = "0.5"; } else { inp.style.opacity = "1"; }
        });
    }

    function abrirModalNovo() {
        document.getElementById('formContrato').action = "{{ url_for('criar_contrato') }}";
        document.getElementById('modalTitle').innerText = "Novo Contrato";
        document.getElementById('formContrato').reset();
        document.getElementById('tbodyImp').innerHTML = "";
        addLinhaImpressora();
        new bootstrap.Modal(document.getElementById('modalContrato')).show();
    }

    function abrirModalEditar() {
        if(!contratoAtualId) return;
        fetch(`/api/contrato_detalhes/${contratoAtualId}`).then(r => r.json()).then(data => {
            document.getElementById('formContrato').action = "{{ url_for('editar_contrato') }}";
            document.getElementById('modalTitle').innerText = "Editar Contrato";
            document.getElementById('form_contrato_id').value = data.id;
            document.getElementById('form_cliente').value = ""; 
            document.getElementById('form_numero').value = data.numero;
            document.getElementById('form_inicio').value = data.data_inicio;
            document.getElementById('form_fim').value = data.data_fim;
            document.getElementById('form_pool').value = data.franquia_global;
            document.getElementById('form_exc_pool').value = data.excedente_global;
            document.getElementById('tbodyImp').innerHTML = "";
            data.impressoras.forEach(imp => { addLinhaImpressora(imp); });
            new bootstrap.Modal(document.getElementById('modalContrato')).show();
        });
    }

    function verDetalhes(id) {
        contratoAtualId = id;
        fetch(`/api/contrato_detalhes/${id}`).then(r => r.json()).then(data => {
            document.getElementById('det_numero').innerText = data.numero;
            document.getElementById('det_cliente').innerText = data.cliente_nome;
            let st = data.status === 'Ativo' ? `<span class="badge bg-soft-A text-success border-0 px-3 py-2">ATIVO</span>` : `<span class="badge bg-soft-C text-danger border-0 px-3 py-2">CANCELADO</span>`;
            document.getElementById('det_status').innerHTML = st;
            document.getElementById('det_vigencia').innerText = `${data.data_inicio_br} até ${data.data_fim_br}`;
            document.getElementById('det_valor').innerText = data.valor_mensal.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'});
            document.getElementById('det_pool_global').innerText = data.franquia_global > 0 ? `${data.franquia_global} Páginas (Exc: R$ ${data.excedente_global})` : "Não configurado";
            
            if(data.pdf_url) { document.getElementById('btn_pdf').href = data.pdf_url; document.getElementById('btn_pdf').classList.remove('disabled'); } 
            else { document.getElementById('btn_pdf').classList.add('disabled'); }

            const tbody = document.getElementById('det_lista_imp');
            tbody.innerHTML = "";
            data.impressoras.forEach(imp => {
                const modeloSafe = imp.modelo.replace(/'/g, "\\'");
                const serialSafe = imp.serial.replace(/'/g, "\\'");
                tbody.innerHTML += `<tr>
                    <td class="ps-3 border-0"><a href="#" class="text-decoration-none fw-bold text-dark" onclick="event.preventDefault(); verHistoricoImpressora(${imp.id}, '${modeloSafe}', '${serialSafe}')">${imp.modelo}</a><br><small class="text-muted">${imp.serial}</small></td>
                    <td class="border-0"><span class="badge bg-light text-secondary border">${imp.tipo_franquia}</span></td>
                    <td class="border-0 text-muted small">${imp.franquia}</td>
                    <td class="text-end fw-bold border-0 text-success">R$ ${imp.valor.toFixed(2)}</td>
                    <td class="text-end border-0"><button class="btn btn-sm btn-light text-primary" onclick="event.preventDefault(); verHistoricoImpressora(${imp.id}, '${modeloSafe}', '${serialSafe}')"><i class="fas fa-eye"></i></button></td>
                </tr>`;
            });
            document.getElementById('contratoDetalhe').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function fecharDetalhes() { document.getElementById('contratoDetalhe').style.display = 'none'; }
    function abrirModalCancelar() { document.getElementById('cancel_id').value = contratoAtualId; new bootstrap.Modal(document.getElementById('modalCancelar')).show(); }

    function verHistoricoImpressora(id, modelo, serial) {
        if (!modalHistImp) modalHistImp = new bootstrap.Modal(document.getElementById('modalHistoricoImpressora'));
        document.getElementById('hist_titulo').innerText = modelo;
        document.getElementById('hist_subtitulo').innerText = "S/N: " + serial;
        document.getElementById('listaMovimentacoes').innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
        
        fetch('/api/historico_completo/' + id).then(response => response.json()).then(data => {
            const listaMov = document.getElementById('listaMovimentacoes');
            listaMov.innerHTML = "";
            if (data.movimentacoes.length > 0) {
                data.movimentacoes.forEach(mov => {
                    listaMov.innerHTML += `<div class="timeline-item"><span class="timeline-date">${mov.data}</span><div class="fw-bold text-dark">${mov.tipo}</div><div class="small text-muted">Origem: ${mov.origem} &rarr; Destino: ${mov.destino}</div><div class="small mt-1 text-dark">Contador: <strong>${mov.contador}</strong></div>${mov.obs ? `<div class="small text-muted fst-italic mt-1">"${mov.obs}"</div>` : ''}</div>`;
                });
            } else { listaMov.innerHTML = '<div class="text-center text-muted py-3">Nenhuma movimentação.</div>'; }

            const listaManut = document.getElementById('accordionManutencoes');
            listaManut.innerHTML = "";
            const msgSemManut = document.getElementById('msgSemManut');
            if (data.manutencoes.length > 0) {
                msgSemManut.style.display = 'none';
                data.manutencoes.forEach((os, index) => {
                    let logsHtml = '<ul class="list-group list-group-flush mt-2">';
                    os.logs.forEach(log => { logsHtml += `<li class="list-group-item bg-transparent px-0 py-2"><div class="d-flex justify-content-between small"><span class="fw-bold text-dark">${log.titulo}</span><span class="text-muted">${log.data}</span></div><div class="small text-muted">${log.obs}</div></li>`; });
                    logsHtml += '</ul>';
                    let badgeStatus = os.status === 'Aberta' ? 'bg-warning text-dark' : 'bg-success';
                    listaManut.innerHTML += `<div class="accordion-item border-0 shadow-sm mb-2 rounded overflow-hidden"><h2 class="accordion-header" id="heading${index}"><button class="accordion-button collapsed bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}"><div class="w-100 d-flex justify-content-between me-3 align-items-center"><span class="fw-bold text-primary">O.S. #${os.numero}</span><span class="badge ${badgeStatus} ms-2">${os.status}</span><span class="small text-muted ms-auto">${os.inicio}</span></div></button></h2><div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#accordionManutencoes"><div class="accordion-body bg-white border-top"><div class="alert alert-light border small mb-0"><strong>Motivo:</strong> ${os.motivo}</div>${logsHtml}<div class="text-end small text-muted border-top pt-2 mt-3">Fim: ${os.fim}</div></div></div></div>`;
                });
            } else { msgSemManut.style.display = 'block'; }
            modalHistImp.show();
        }).catch(err => { console.error(err); alert("Erro ao carregar histórico."); });
    }
</script>
{% endblock %}