{% extends "base.html" %}

{% block content %}
<style>
    /* --- PADRÃO VISUAL (ADAPTÁVEL) --- */
    
    /* Título */
    .page-title { 
        color: var(--text-main) !important; 
        font-family: 'Inter', sans-serif; 
        font-weight: 700; 
        margin-bottom: 5px; 
    }

    /* Navegação por Abas */
    .nav-tabs .nav-link { 
        color: var(--text-muted); 
        font-weight: 600; 
        border: none; 
        border-bottom: 3px solid transparent; 
        padding: 12px 20px; 
        transition: all 0.2s;
    }
    .nav-tabs .nav-link:hover { color: var(--text-main); }
    .nav-tabs .nav-link.active { 
        color: var(--text-main) !important; 
        background: transparent; 
        border-bottom-color: var(--text-main); 
    }
    
    /* Cards e Containers */
    .card-table-clean { 
        background-color: var(--card-bg) !important;
        border: none; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
        border-radius: 8px; 
    }

    /* Tabela */
    .table thead th { 
        background-color: transparent !important; 
        color: var(--text-muted) !important; 
        font-size: 0.8rem; 
        text-transform: uppercase; 
        border-bottom: 2px solid var(--border-color); 
        border-top: none;
        font-weight: 600;
        padding: 12px 15px;
    }
    
    .table tbody td {
        background-color: transparent !important;
        color: var(--text-main) !important;
        border-bottom: 1px solid var(--border-color);
        padding: 12px 15px;
        vertical-align: middle;
    }
    
    .table-hover tbody tr:hover { 
        background-color: rgba(128, 128, 128, 0.05) !important; 
    }
    
    /* Status Badges */
    .badge-status { padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .st-pendente { background-color: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); }
    .st-entregue { background-color: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
    .st-cancelado { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }

    /* Inputs na Tabela (Modal Pedido) */
    .table-input { 
        border: 1px solid transparent; 
        background: transparent; 
        width: 100%; 
        padding: 5px; 
        color: var(--text-main); 
    }
    .table-input:focus { 
        outline: none; 
        background: var(--input-bg); 
        border-color: var(--primary-color); 
        border-radius: 4px; 
        color: var(--text-main);
    }
    
    /* Utilitários */
    .text-muted { color: var(--text-muted) !important; }
    .fw-bold { color: var(--text-main) !important; }
</style>

<div id="fornecedores-page" class="page-content active">
    
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Gestão de Fornecedores</h1>
                <p class="text-muted small mb-0">Contatos e Compras</p>
            </div>
            <div>
                <button class="btn btn-primary btn-action shadow-sm me-2" onclick="abrirModalFornecedor()">
                    <i class="fas fa-user-plus me-2"></i> Novo Fornecedor
                </button>
                <button class="btn btn-success btn-action shadow-sm" onclick="abrirModalPedido()">
                    <i class="fas fa-cart-plus me-2"></i> Novo Pedido
                </button>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="fornecedorTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link {% if active_tab == 'contatos' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#tab-contatos">Contatos</button>
        </li>
        <li class="nav-item">
            <button class="nav-link {% if active_tab == 'pedidos' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#tab-pedidos">Pedidos de Compra</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade {% if active_tab == 'contatos' %}show active{% endif %}" id="tab-contatos">
            <div class="card card-table-clean">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead><tr><th class="ps-4">NOME</th><th>E-MAIL</th><th>TELEFONE</th><th>AÇÕES</th></tr></thead>
                            <tbody>
                                {% for f in fornecedores %}
                                <tr>
                                    <td class="ps-4 fw-bold">{{ f.nome }}</td>
                                    <td class="text-muted">{{ f.email }}</td>
                                    <td class="text-muted">{{ f.telefone }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-light text-primary" onclick="editarFornecedor('{{ f.id }}', '{{ f.nome }}', '{{ f.email }}', '{{ f.telefone }}', `{{ f.observacao }}`)" title="Editar"><i class="fas fa-edit"></i></button>
                                        <a href="{{ url_for('excluir_fornecedor', id=f.id) }}" class="btn btn-sm btn-light text-danger" onclick="return confirm('Excluir este fornecedor?')" title="Excluir"><i class="fas fa-trash"></i></a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center p-4 text-muted">Nenhum fornecedor cadastrado.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'pedidos' %}show active{% endif %}" id="tab-pedidos">
            <div class="card card-table-clean">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead><tr><th class="ps-4">Nº PEDIDO</th><th>DATA</th><th>FORNECEDOR</th><th>VALOR TOTAL</th><th>STATUS</th><th class="text-end pe-4">AÇÕES</th></tr></thead>
                            <tbody>
                                {% for p in pedidos %}
                                <tr>
                                    <td class="ps-4 text-muted">#{{ p.id }}</td>
                                    <td>{{ p.data_emissao.strftime('%d/%m/%Y') }}</td>
                                    <td class="fw-bold">{{ p.fornecedor.nome }}</td>
                                    <td class="fw-bold text-success">R$ {{ "%.2f"|format(p.valor_total) }}</td>
                                    <td>
                                        {% if p.status == 'Pendente' %}<span class="badge-status st-pendente">Pendente</span>
                                        {% elif p.status == 'Entregue' %}<span class="badge-status st-entregue">Entregue</span>
                                        {% else %}<span class="badge-status st-cancelado">Cancelado</span>{% endif %}
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-light text-info" onclick="verResumoPedido('{{ p.id }}')" title="Resumo"><i class="fas fa-eye"></i></button>
                                        
                                        {% if p.status == 'Pendente' %}
                                        <button class="btn btn-sm btn-light text-primary" onclick="editarPedido('{{ p.id }}')" title="Editar"><i class="fas fa-pen"></i></button>
                                        <a href="{{ url_for('receber_pedido_compra', id=p.id) }}" class="btn btn-sm btn-light text-success" title="Confirmar Recebimento (Entrada Estoque)" onclick="return confirm('Confirmar entrada dos itens no estoque?')"><i class="fas fa-check-double"></i></a>
                                        <a href="{{ url_for('cancelar_pedido_compra', id=p.id) }}" class="btn btn-sm btn-light text-danger" title="Cancelar Pedido" onclick="return confirm('Cancelar este pedido?')"><i class="fas fa-times"></i></a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="text-center p-4 text-muted">Nenhum pedido de compra registrado.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPedido" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title text-white" id="tituloModalPedido">Novo Pedido de Compra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('salvar_pedido_compra') }}" method="POST" id="formPedido">
                <input type="hidden" name="pedido_id" id="ped_id">
                
                <div class="modal-body">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Fornecedor</label>
                                    <select class="form-select" name="fornecedor_id" id="ped_fornecedor" required>
                                        <option value="">Selecione...</option>
                                        {% for f in fornecedores %}<option value="{{ f.id }}">{{ f.nome }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2"><label class="form-label small fw-bold">Data Emissão</label><input type="date" class="form-control" name="data_emissao" id="ped_emissao" value="{{ hoje.strftime('%Y-%m-%d') }}" required></div>
                                <div class="col-md-2"><label class="form-label small fw-bold">Previsão Entrega</label><input type="date" class="form-control" name="data_entrega" id="ped_entrega"></div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Prazo Pagamento</label>
                                    <select class="form-select" name="prazo_pagamento" id="ped_prazo" required>
                                        <option value="A vista">A vista</option>
                                        <option value="15 dias">15 dias</option>
                                        <option value="30 dias">30 dias</option>
                                        <option value="30/60 dias">30/60 dias</option>
                                        <option value="30/60/90 dias">30/60/90 dias</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header fw-bold">Itens do Pedido</div>
                        <div class="card-body p-0">
                            <table class="table table-bordered mb-0" id="tabelaItens">
                                <thead><tr><th width="40%">Produto</th><th width="15%">Qtd</th><th width="20%">Valor Unit. (R$)</th><th width="20%">Total (R$)</th><th width="5%"></th></tr></thead>
                                <tbody id="listaItens"></tbody>
                                <tfoot><tr><td colspan="5"><button type="button" class="btn btn-sm btn-outline-success" onclick="adicionarLinhaItem()"><i class="fas fa-plus"></i> Adicionar Item</button></td></tr></tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row justify-content-end text-end">
                                <div class="col-md-3"><label class="small text-muted fw-bold">Subtotal Itens</label><h5 id="display_subtotal">R$ 0,00</h5></div>
                                <div class="col-md-3"><label class="small text-muted fw-bold">Frete (R$)</label><input type="number" step="0.01" class="form-control text-end" name="frete" id="ped_frete" value="0.00" onchange="calcularTotais()"></div>
                                <div class="col-md-3"><label class="small text-success fw-bold">TOTAL PEDIDO</label><h3 class="text-success" id="display_total">R$ 0,00</h3></div>
                            </div>
                            <div class="mt-3"><label class="form-label small fw-bold">Observações</label><textarea class="form-control" name="observacao" id="ped_obs" rows="2"></textarea></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0"><button type="submit" class="btn btn-success w-100">Salvar Pedido</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalResumo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title text-white">Resumo do Pedido #<span id="res_id"></span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-6"><small class="text-muted">Fornecedor</small><h5 class="fw-bold" id="res_fornecedor"></h5></div>
                    <div class="col-6 text-end"><span class="badge bg-secondary mb-2" id="res_status"></span><br><small class="text-muted">Emissão: <span id="res_emissao"></span></small></div>
                </div>
                <table class="table table-striped table-sm mb-4"><thead><tr><th>Item</th><th class="text-center">Qtd</th><th class="text-end">Unit.</th><th class="text-end">Total</th></tr></thead><tbody id="res_lista_itens"></tbody></table>
                <div class="row border-top pt-3">
                    <div class="col-6"><p class="mb-1"><strong>Prazo:</strong> <span id="res_prazo"></span></p><p class="mb-1"><strong>Entrega Prevista:</strong> <span id="res_entrega"></span></p><p class="text-muted small"><em>Obs: <span id="res_obs"></span></em></p></div>
                    <div class="col-6 text-end"><p class="mb-1">Itens: <span id="res_subtotal_val"></span></p><p class="mb-1">Frete: <span id="res_frete_val"></span></p><h4 class="text-success fw-bold">Total: <span id="res_total_val"></span></h4></div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFornecedor" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fornecedor</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('criar_fornecedor') }}" method="POST" id="formFornecedor">
                <input type="hidden" name="fornecedor_id" id="forn_id">
                <div class="modal-body">
                    <input type="text" name="nome" id="forn_nome" class="form-control mb-2" placeholder="Nome" required>
                    <input type="text" name="email" id="forn_email" class="form-control mb-2" placeholder="Email">
                    <input type="text" name="telefone" id="forn_tel" class="form-control mb-2" placeholder="Telefone">
                    <textarea name="observacao" id="forn_obs" class="form-control" placeholder="Obs"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    var modalPedido = new bootstrap.Modal(document.getElementById('modalPedido'));
    var modalResumo = new bootstrap.Modal(document.getElementById('modalResumo'));
    var modalForn = new bootstrap.Modal(document.getElementById('modalFornecedor'));

    function abrirModalFornecedor() { 
        document.getElementById('formFornecedor').reset();
        document.getElementById('forn_id').value = "";
        // Garante que a ação seja criar quando for novo
        document.getElementById('formFornecedor').action = "{{ url_for('criar_fornecedor') }}";
        modalForn.show(); 
    }
    
    function abrirModalPedido() {
        document.getElementById('tituloModalPedido').innerText = "Novo Pedido";
        document.getElementById('ped_id').value = "";
        document.getElementById('formPedido').reset();
        document.getElementById('listaItens').innerHTML = "";
        adicionarLinhaItem();
        calcularTotais();
        modalPedido.show();
    }

    function editarPedido(id) {
        document.getElementById('tituloModalPedido').innerText = "Editar Pedido #" + id;
        document.getElementById('ped_id').value = id;
        
        fetch('/api/pedido_compra/' + id).then(res => res.json()).then(data => {
            document.getElementById('ped_fornecedor').value = data.fornecedor_id;
            document.getElementById('ped_emissao').value = data.data_emissao;
            document.getElementById('ped_entrega').value = data.data_entrega;
            document.getElementById('ped_prazo').value = data.prazo;
            document.getElementById('ped_frete').value = data.frete;
            document.getElementById('ped_obs').value = data.observacao;
            
            const tbody = document.getElementById('listaItens');
            tbody.innerHTML = "";
            data.itens.forEach(item => { adicionarLinhaItem(item.produto_id, item.descricao, item.quantidade, item.valor_unitario); });
            calcularTotais();
            modalPedido.show();
        });
    }

    function adicionarLinhaItem(prodId='', desc='', qtd=1, val=0) {
        const tbody = document.getElementById('listaItens');
        const tr = document.createElement('tr');
        
        let produtosOptions = '<option value="">Outro (Digitar)</option>';
        {% for p in produtos %}
        produtosOptions += `<option value="{{ p.id }}">{{ p.nome }}</option>`;
        {% endfor %}

        tr.innerHTML = `
            <td>
                <div class="input-group input-group-sm">
                    <select class="form-select" name="item_produto_id" onchange="atualizarDesc(this)">${produtosOptions}</select>
                    <input type="text" class="form-control" name="item_desc" value="${desc}" placeholder="Descrição do item" ${prodId ? 'style="display:none"' : ''}>
                </div>
            </td>
            <td><input type="number" class="table-input text-center" name="item_qtd" value="${qtd}" min="1" onchange="calcularTotais()"></td>
            <td><input type="number" class="table-input text-end" name="item_valor" value="${val}" step="0.01" onchange="calcularTotais()"></td>
            <td class="text-end fw-bold row-total">R$ 0,00</td>
            <td class="text-center"><button type="button" class="btn btn-sm text-danger" onclick="removerLinha(this)"><i class="fas fa-times"></i></button></td>
        `;
        tbody.appendChild(tr);
        if(prodId) { const sel = tr.querySelector('select'); sel.value = prodId; }
        calcularTotais();
    }

    function atualizarDesc(select) {
        const input = select.nextElementSibling;
        if (select.value === "") { input.style.display = "block"; input.value = ""; input.focus(); } 
        else { input.style.display = "none"; input.value = select.options[select.selectedIndex].text; }
    }

    function removerLinha(btn) { btn.closest('tr').remove(); calcularTotais(); }

    function calcularTotais() {
        let subtotal = 0;
        document.querySelectorAll('#listaItens tr').forEach(tr => {
            const qtd = parseFloat(tr.querySelector('[name="item_qtd"]').value) || 0;
            const val = parseFloat(tr.querySelector('[name="item_valor"]').value) || 0;
            const total = qtd * val;
            tr.querySelector('.row-total').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            subtotal += total;
        });
        const frete = parseFloat(document.getElementById('ped_frete').value) || 0;
        document.getElementById('display_subtotal').innerText = subtotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        document.getElementById('display_total').innerText = (subtotal + frete).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
    }

    function verResumoPedido(id) {
        fetch('/api/pedido_compra/' + id).then(res => res.json()).then(data => {
            document.getElementById('res_id').innerText = data.id;
            document.getElementById('res_fornecedor').innerText = data.fornecedor_nome;
            document.getElementById('res_status').innerText = data.status;
            document.getElementById('res_emissao').innerText = data.data_emissao;
            document.getElementById('res_prazo').innerText = data.prazo;
            document.getElementById('res_entrega').innerText = data.data_entrega || '-';
            document.getElementById('res_obs').innerText = data.observacao || '-';
            
            const tbody = document.getElementById('res_lista_itens');
            tbody.innerHTML = "";
            data.itens.forEach(i => {
                tbody.innerHTML += `<tr><td>${i.descricao}</td><td class="text-center">${i.quantidade}</td><td class="text-end">R$ ${i.valor_unitario.toFixed(2)}</td><td class="text-end">R$ ${i.valor_total.toFixed(2)}</td></tr>`;
            });
            document.getElementById('res_subtotal_val').innerText = "R$ " + data.valor_itens.toFixed(2);
            document.getElementById('res_frete_val').innerText = "R$ " + data.frete.toFixed(2);
            document.getElementById('res_total_val').innerText = "R$ " + data.valor_total.toFixed(2);
            modalResumo.show();
        });
    }
    
    function editarFornecedor(id, nome, email, tel, obs) {
        document.getElementById('formFornecedor').reset();
        document.getElementById('forn_id').value = id;
        document.getElementById('forn_nome').value = nome;
        document.getElementById('forn_email').value = email;
        document.getElementById('forn_tel').value = tel;
        document.getElementById('forn_obs').value = obs;
        // Ajusta a rota para edição
        document.getElementById('formFornecedor').action = "{{ url_for('editar_fornecedor') }}";
        modalForn.show();
    }
</script>
{% endblock %}