{% extends "base.html" %}

{% block content %}
<style>
    /* --- Estilos da Página --- */
    .page-title { color: #2C3E50 !important; font-family: 'Segoe UI', sans-serif; font-weight: 700; margin-bottom: 5px; }
    
    /* Cards Estilo Dashboard */
    .card-dashboard { 
        border: none; 
        border-radius: 8px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        color: white; 
        transition: transform 0.2s; 
        position: relative; 
        overflow: hidden; 
    }
    .card-dashboard:hover { transform: translateY(-3px); }
    .card-dashboard h3 { font-weight: 700; font-size: 2.2rem; margin: 0; }
    .card-dashboard small { text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; opacity: 0.95; }
    
    /* Gradientes */
    .bg-gradient-primary { background: linear-gradient(135deg, #2980b9, #2c3e50); } 
    .bg-gradient-success { background: linear-gradient(135deg, #27ae60, #16a085); }
    .bg-gradient-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .bg-gradient-danger  { background: linear-gradient(135deg, #e74c3c, #c0392b); }

    /* Badge de Status */
    .badge-status { padding: 5px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .status-disp { background-color: rgba(39, 174, 96, 0.1); color: #27ae60; border: 1px solid rgba(39, 174, 96, 0.2); }
    .status-loc { background-color: rgba(52, 152, 219, 0.1); color: #2980b9; border: 1px solid rgba(52, 152, 219, 0.2); }
    .status-manut { background-color: rgba(243, 156, 18, 0.1); color: #d35400; border: 1px solid rgba(243, 156, 18, 0.2); }

    /* Timeline Vertical (Histórico) */
    .timeline { position: relative; padding-left: 30px; border-left: 2px solid #e9ecef; margin-left: 10px; margin-top: 20px; }
    .timeline-item { position: relative; margin-bottom: 25px; }
    .timeline-marker { position: absolute; top: 0; left: -36px; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 3px solid #007bff; }
    .timeline-content { padding-bottom: 5px; }
    .timeline-date { font-size: 0.8rem; color: #6c757d; font-weight: 600; margin-bottom: 2px; }
    .timeline-title { font-weight: 700; font-size: 1rem; color: #2c3e50; }
    
    /* Tabela Clicável */
    .clickable-row { cursor: pointer; transition: background-color 0.1s; }
    
    /* Form de Manutenção no Histórico */
    .os-log-box { background-color: rgba(243, 156, 18, 0.05); border-left: 4px solid #f39c12; padding: 15px; border-radius: 4px; margin-bottom: 20px; }

    /* Modo Escuro Ajustes Específicos */
    body.dark-mode .timeline { border-left-color: #2d3748; }
    body.dark-mode .timeline-marker { background: #1a222c; border-color: #3498db; }
    body.dark-mode .timeline-title { color: #e0e6ed; }
    body.dark-mode .timeline-date { color: #94a3b8; }
    body.dark-mode .os-log-box { background-color: rgba(243, 156, 18, 0.1); }
    body.dark-mode .clickable-row:hover { background-color: rgba(255, 255, 255, 0.05) !important; }
</style>

<div id="impressoras-page" class="page-content active">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Impressoras</h1>
                <p class="page-subtitle mb-0">Gestão de parque e status</p>
            </div>
            <div>
                <button class="btn btn-primary btn-action shadow-sm me-2" onclick="abrirModalNova()">
                    <i class="fas fa-plus me-2"></i> Nova Impressora
                </button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-primary p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ total }}</h3><small>Total Máquinas</small></div>
                    <i class="fas fa-print fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-success p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ disponiveis }}</h3><small>Disponíveis</small></div>
                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-warning p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ locadas }}</h3><small>Locadas</small></div>
                    <i class="fas fa-truck-loading fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-dashboard bg-gradient-danger p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ manutencao }}</h3><small>Em Manutenção</small></div>
                    <i class="fas fa-tools fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4 filter-bar">
        <div class="card-body py-3">
            <form method="GET" action="{{ url_for('impressoras') }}" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Buscar</label>
                    <input type="text" class="form-control" name="busca" placeholder="Modelo, Serial ou Local..." value="{{ request.args.get('busca', '') }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Status</label>
                    <select class="form-select" name="status">
                        <option value="Todas">Todos</option>
                        <option value="Disponível" {% if request.args.get('status') == 'Disponível' %}selected{% endif %}>Disponível</option>
                        <option value="Locada" {% if request.args.get('status') == 'Locada' %}selected{% endif %}>Locada</option>
                        <option value="Manutenção" {% if request.args.get('status') == 'Manutenção' %}selected{% endif %}>Manutenção</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Cliente (Local)</label>
                    <select class="form-select" name="cliente_id">
                        <option value="Todos">Todos</option>
                        {% for c in clientes %}
                            <option value="{{ c.id }}" {% if request.args.get('cliente_id') == c.id|string %}selected{% endif %}>{{ c.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-primary w-100 fw-bold"><i class="fas fa-filter me-2"></i>Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead>
                        <tr>
                            <th class="ps-4">Modelo / Serial</th>
                            <th>Status</th>
                            <th>Localização</th>
                            <th>Contador</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for imp in impressoras %}
                        <tr class="clickable-row" onclick="abrirHistorico('{{ imp.id }}', '{{ imp.status }}')">
                            <td class="ps-4">
                                <div class="fw-bold text-dark">{{ imp.modelo }}</div>
                                <div class="text-muted small">
                                    <span class="me-2"><i class="fas fa-barcode me-1"></i> {{ imp.serial }}</span>
                                    {% if imp.mlt %}<span class="me-2 text-primary">| MLT: {{ imp.mlt }}</span>{% endif %}
                                </div>
                                {% if imp.observacao %}
                                    <div class="text-muted small fst-italic mt-1"><i class="fas fa-info-circle me-1"></i> {{ imp.observacao }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if imp.status == 'Disponível' %} <span class="badge-status status-disp">Disponível</span>
                                {% elif imp.status == 'Locada' %} <span class="badge-status status-loc">Locada</span>
                                {% else %} <span class="badge-status status-manut">Manutenção</span> {% endif %}
                            </td>
                            <td><i class="fas fa-map-marker-alt text-muted me-1"></i> {{ imp.localizacao }}</td>
                            <td class="fw-bold">{{ imp.contador }}</td>
                            <td class="text-end pe-4">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-sm btn-outline-dark" 
        onclick="event.stopPropagation(); abrirMovimentacao('{{ imp.id }}', '{{ imp.modelo }}', '{{ imp.contador }}', '{{ imp.status }}', '{{ imp.localizacao }}')" 
        title="Movimentar">
    <i class="fas fa-exchange-alt"></i>
                    </button>
                                    <button class="btn btn-sm btn-outline-primary" 
        onclick="event.stopPropagation(); abrirEdicao('{{ imp.id }}', '{{ imp.marca }}', '{{ imp.modelo }}', '{{ imp.serial }}', '{{ imp.mlt }}', '{{ imp.observacao }}', '{{ imp.contador }}')" 
        title="Editar">
    <i class="fas fa-edit"></i>
</button>
                                    <a href="{{ url_for('excluir_impressora', id=imp.id) }}" 
                                       class="btn btn-sm btn-outline-danger" 
                                       onclick="event.stopPropagation(); return confirm('Excluir esta impressora?')" 
                                       title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center p-5 text-muted">Nenhuma impressora encontrada.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovaImpressora" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Nova Impressora</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('criar_impressora') }}" method="POST">
                <div class="modal-body bg-light">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <span class="section-title">Identificação do Equipamento</span>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">Marca</label>
                                    <select class="form-select" name="marca" required>
                                        <option value="" disabled selected>Selecione...</option>
                                        <option value="Kyocera">Kyocera</option>
                                        <option value="Epson">Epson</option>
                                        <option value="Canon">Canon</option>
                                        <option value="HP">HP</option>
                                        <option value="Samsung">Samsung</option>
                                        <option value="Ricoh">Ricoh</option>
                                        <option value="Brother">Brother</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small fw-bold text-muted">Modelo</label>
                                    <input type="text" class="form-control" name="modelo" placeholder="Ex: M420dn" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">Serial Number (S/N)</label>
                                    <input type="text" class="form-control" name="serial" placeholder="Número de Série único" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">Contador Inicial</label>
                                    <input type="number" class="form-control" name="contador" value="0">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold text-muted">MLT</label>
                                    <input type="text" class="form-control" name="mlt" placeholder="MLT da impressora">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <span class="section-title">Observações</span>
                            <textarea class="form-control border-0 bg-light" name="observacao" rows="2" placeholder="Detalhes adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">Cadastrar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMovimentacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Movimentar Equipamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form action="{{ url_for('movimentar_impressora') }}" method="POST">
                <input type="hidden" name="impressora_id" id="mov_id">
                
<div class="modal-body bg-light">
    
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3">
                    <i class="fas fa-print fa-lg"></i>
                </div>
                <div>
                    <h6 class="mb-0 fw-bold text-dark" id="mov_titulo">...</h6>
                    <small class="text-muted">Equipamento selecionado</small>
                </div>
            </div>
            
            <div id="mov_status_aviso" class="alert p-2 mb-0 text-center small fw-bold">
                </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <span class="section-title">Dados da Movimentação</span>
            
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label small fw-bold text-muted">Ação Desejada</label>
                    <select class="form-select" name="tipo_movimentacao" id="selectTipoMov" onchange="toggleClienteMov()" required>
                        <option value="Locação">Enviar para Locação (Cliente)</option>
                        <option value="Devolução">Devolver ao Estoque</option>
                        <option value="Manutenção" class="text-danger fw-bold">Enviar para Manutenção</option>
                        <option value="Disponibilizar" class="text-success fw-bold">Finalizar Manutenção</option>
                    </select>
                </div>

                <div class="col-12" id="divClienteMov">
                    <label class="form-label small fw-bold text-muted">Cliente Destino</label>
                    <select class="form-select" name="cliente_id">
                        <option value="">Selecione o cliente...</option>
                        {% for c in clientes %}
                        <option value="{{ c.id }}">{{ c.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label small fw-bold text-muted">Contador Atual</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white text-muted border-end-0"><i class="fas fa-tachometer-alt"></i></span>
                        <input type="number" class="form-control border-start-0 ps-0" name="contador_atual" id="mov_contador" required>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label small fw-bold text-muted">Observação / Motivo</label>
                    <textarea class="form-control bg-light" name="observacao" rows="2" placeholder="Descreva o motivo..."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>


                <div class="modal-footer border-top-0 bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="modalEditarImpressora" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title text-primary"><i class="fas fa-edit me-2"></i>Editar Impressora</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form action="{{ url_for('editar_impressora') }}" method="POST" id="formEditarImpressora">
                <input type="hidden" name="impressora_id" id="edit_imp_id">
                
                <div class="modal-body bg-light">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">Marca</label>
                                    <select class="form-select" name="marca" id="edit_marca" required>
                                        <option value="Kyocera">Kyocera</option>
                                        <option value="Epson">Epson</option>
                                        <option value="Canon">Canon</option>
                                        <option value="HP">HP</option>
                                        <option value="Samsung">Samsung</option>
                                        <option value="Ricoh">Ricoh</option>
                                        <option value="Brother">Brother</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small fw-bold text-muted">Modelo (Sem a marca)</label>
                                    <input type="text" class="form-control" name="modelo" id="edit_modelo" required>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">Serial</label>
                                    <input type="text" class="form-control" name="serial" id="edit_serial">
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">Contador Atual</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white text-muted"><i class="fas fa-tachometer-alt"></i></span>
                                        <input type="number" class="form-control" name="contador" id="edit_contador" data-original="">
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label small fw-bold text-muted">MLT</label>
                                    <input type="text" class="form-control" name="mlt" id="edit_mlt">
                                </div>
                                
                                <div class="col-12">
                                    <label class="form-label small fw-bold text-muted">Obs</label>
                                    <textarea class="form-control" name="observacao" id="edit_obs"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-light">
                    <button type="button" class="btn btn-primary px-4" onclick="verificarAlteracaoContador()">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="modalAvisoContador" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark border-bottom-0 justify-content-center">
                <i class="fas fa-exclamation-triangle fa-3x"></i>
            </div>
            <div class="modal-body text-center pt-0">
                <h5 class="fw-bold mt-3">Atenção!</h5>
                <p class="small text-muted mb-4">
                    Você alterou o contador manualmente.<br>
                    Isso pode impactar o histórico de cobrança.
                </p>
                <p class="fw-bold mb-3">Deseja realmente salvar?</p>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-dark fw-bold" onclick="finalizarEdicao()">Sim, Salvar</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modalHistorico" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom">
                <div>
                    <h5 class="modal-title fw-bold"><i class="fas fa-history me-2"></i>Histórico do Equipamento</h5>
                    <div id="hist_badges" class="mt-1"></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="px-3 pt-3 border-bottom">
                <ul class="nav nav-tabs nav-justified" id="histTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-mov">
                            <i class="fas fa-route me-2"></i>Ciclo de Vida
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-manut">
                            <i class="fas fa-tools me-2"></i>Manutenções
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-insumos">
                            <i class="fas fa-box-open me-2"></i>Insumos
                        </button>
                    </li>
                </ul>
            </div>

            <div class="modal-body p-4">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-mov">
                        <div id="timeline_container" class="timeline"></div>
                    </div>

                    <div class="tab-pane fade" id="tab-manut">
                        <div id="area_adicionar_log" style="display: none;">
                            <div class="os-log-box shadow-sm">
                                <h6 class="fw-bold text-warning mb-3"><i class="fas fa-pen-square me-2"></i>Atualizar O.S. em Andamento</h6>
                                <form action="{{ url_for('adicionar_log_manutencao') }}" method="POST">
                                    <input type="hidden" name="impressora_id" id="hist_form_imp_id">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" name="status_detalhe">
                                                <option value="Diagnóstico Técnico">Diagnóstico Técnico</option>
                                                <option value="Troca de Peça">Troca de Peça</option>
                                                <option value="Limpeza">Limpeza</option>
                                                <option value="Aguardando Peça">Aguardando Peça</option>
                                                <option value="Teste Final">Teste Final</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" name="observacao" placeholder="Descreva o procedimento..." required>
                                                <button class="btn btn-warning fw-bold" type="submit">Salvar</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="accordion shadow-sm" id="accordionManutencoes"></div>
                    </div>

                    <div class="tab-pane fade" id="tab-insumos">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr><th>Data</th><th>Produto</th><th class="text-center">Qtd</th><th class="text-end">Ref.</th></tr>
                                </thead>
                                <tbody id="tabelaInsumosImpressora"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- 1. INICIALIZAÇÃO DOS MODAIS ---
    var modalNova = new bootstrap.Modal(document.getElementById('modalNovaImpressora'));
    var modalMov = new bootstrap.Modal(document.getElementById('modalMovimentacao'));
    var modalEdit = new bootstrap.Modal(document.getElementById('modalEditarImpressora'));
    var modalHist = new bootstrap.Modal(document.getElementById('modalHistorico'));
    var modalAviso = new bootstrap.Modal(document.getElementById('modalAvisoContador'));

    // --- 2. FUNÇÕES DE NOVA IMPRESSORA ---
    function abrirModalNova() {
        modalNova.show();
    }

    // --- 3. FUNÇÕES DE MOVIMENTAÇÃO ---
    function abrirMovimentacao(id, modelo, contador, statusAtual, localizacao) {
        document.getElementById('mov_id').value = id;
        document.getElementById('mov_titulo').innerText = modelo;
        document.getElementById('mov_contador').value = contador;
        
        // Configuração do Aviso Visual de Status
        var aviso = document.getElementById('mov_status_aviso');
        aviso.className = "alert p-2 mb-0 text-center small fw-bold "; // Reseta classes
        
        if (statusAtual === 'Disponível') {
            aviso.classList.add('alert-success');
            aviso.innerHTML = '<i class="fas fa-check-circle me-1"></i> Atualmente em ESTOQUE';
        } else if (statusAtual === 'Locada') {
            aviso.classList.add('alert-warning');
            aviso.classList.add('text-dark');
            aviso.innerHTML = '<i class="fas fa-map-marker-alt me-1"></i> Local atual: ' + localizacao;
        } else {
            aviso.classList.add('alert-danger');
            aviso.innerHTML = '<i class="fas fa-tools me-1"></i> Atualmente em MANUTENÇÃO';
        }

        // Seleção inteligente da ação baseada no status
        var select = document.getElementById('selectTipoMov');
        if(statusAtual === 'Disponível') {
            select.value = 'Locação'; 
        } else if(statusAtual === 'Locada') {
            select.value = 'Devolução';
        } else if(statusAtual === 'Manutenção') {
            select.value = 'Disponibilizar';
        }
        
        toggleClienteMov(); // Ajusta visibilidade do campo cliente
        modalMov.show();
    }

    function toggleClienteMov() {
        var tipo = document.getElementById('selectTipoMov').value;
        var div = document.getElementById('divClienteMov');
        var selectCli = div.querySelector('select');

        if (tipo === 'Locação') {
            div.style.display = 'block';
            selectCli.setAttribute('required', 'required');
        } else {
            div.style.display = 'none';
            selectCli.removeAttribute('required');
            selectCli.value = ""; // Limpa seleção para evitar erros
        }
    }

    // --- 4. FUNÇÕES DE EDIÇÃO COM VALIDAÇÃO DE CONTADOR ---
    function abrirEdicao(id, marca, modeloFull, serial, mlt, obs, contador) {
        document.getElementById('edit_imp_id').value = id;
        document.getElementById('edit_marca').value = marca;
        
        // Remove a marca do nome do modelo para exibir limpo
        let modeloLimpo = modeloFull.replace(marca, '').trim();
        document.getElementById('edit_modelo').value = modeloLimpo;
        
        document.getElementById('edit_serial').value = serial;
        document.getElementById('edit_mlt').value = mlt;
        document.getElementById('edit_obs').value = obs;
        
        // Configura contador e salva valor original para comparação
        var inputContador = document.getElementById('edit_contador');
        inputContador.value = contador;
        inputContador.setAttribute('data-original', contador);
        
        modalEdit.show();
    }

    function verificarAlteracaoContador() {
        var input = document.getElementById('edit_contador');
        var original = input.getAttribute('data-original');
        var atual = input.value;

        // Se o valor mudou, abre o modal de aviso e impede o envio imediato
        if (original != atual) {
            modalAviso.show();
            return; 
        }
        
        // Se não mudou, salva direto
        finalizarEdicao();
    }

    function finalizarEdicao() {
        // Envia o formulário
        document.getElementById('formEditarImpressora').submit();
    }

    // --- 5. FUNÇÕES DE HISTÓRICO (TIMELINE E O.S.) ---
    function abrirHistorico(id, statusAtual) {
        // Configura Formulário de O.S. (Só exibe se estiver em Manutenção)
        document.getElementById('hist_form_imp_id').value = id;
        var divForm = document.getElementById('area_adicionar_log');
        var badgeContainer = document.getElementById('hist_badges');

        if (statusAtual === 'Manutenção') {
            divForm.style.display = 'block';
            badgeContainer.innerHTML = '<span class="badge bg-danger shadow-sm">EM MANUTENÇÃO</span>';
        } else {
            divForm.style.display = 'none';
            if(statusAtual === 'Locada') {
                badgeContainer.innerHTML = '<span class="badge bg-warning text-dark shadow-sm">LOCADA</span>';
            } else {
                badgeContainer.innerHTML = '<span class="badge bg-success shadow-sm">DISPONÍVEL</span>';
            }
        }

        // Elementos de UI para Loading
        var timeline = document.getElementById('timeline_container');
        var listaManut = document.getElementById('accordionManutencoes');
        var listaInsumos = document.getElementById('tabelaInsumosImpressora');
        
        // Mostra spinners
        timeline.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
        listaManut.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-danger"></div></div>';
        listaInsumos.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="spinner-border text-success"></div></td></tr>';
        
        modalHist.show();

        // Busca dados completos
        fetch('/api/historico_completo/' + id)
            .then(response => response.json())
            .then(data => {
                
                // A. Renderizar Timeline (Movimentações)
                timeline.innerHTML = '';
                if (!data.movimentacoes || data.movimentacoes.length === 0) {
                    timeline.innerHTML = '<div class="text-muted fst-italic ms-3 p-3">Nenhuma movimentação registrada.</div>';
                } else {
                    data.movimentacoes.forEach(m => {
                        // Cores da Timeline
                        let borderClass = '#0d6efd'; // Azul padrão
                        if(m.tipo.includes('Manutenção')) borderClass = '#dc3545'; // Vermelho
                        if(m.tipo.includes('Locação')) borderClass = '#ffc107'; // Amarelo
                        if(m.tipo.includes('Devolução')) borderClass = '#198754'; // Verde

                        let html = `
                            <div class="timeline-item">
                                <div class="timeline-marker" style="border-color: ${borderClass}"></div>
                                <div class="timeline-content">
                                    <div class="timeline-date">${m.data}</div>
                                    <div class="timeline-title">${m.tipo}</div>
                                    <div class="text-muted small">
                                        ${m.origem} <i class="fas fa-arrow-right mx-1"></i> <strong>${m.destino}</strong>
                                    </div>
                                    ${m.obs ? `<div class="text-muted small fst-italic mt-1 border-top pt-1" style="border-color: rgba(0,0,0,0.05) !important;">${m.obs}</div>` : ''}
                                </div>
                            </div>
                        `;
                        timeline.innerHTML += html;
                    });
                }

                // B. Renderizar Manutenções (Accordion)
                listaManut.innerHTML = '';
                if (!data.manutencoes || data.manutencoes.length === 0) {
                    listaManut.innerHTML = '<div class="alert alert-light border text-center text-muted">Nenhum histórico de O.S.</div>';
                } else {
                    data.manutencoes.forEach((os, index) => {
                        let badge = os.status === 'Aberta' 
                            ? '<span class="badge bg-warning text-dark">ABERTA</span>' 
                            : '<span class="badge bg-secondary">FECHADA</span>';
                        
                        let collapseShow = index === 0 ? 'show' : ''; // Abre só o primeiro
                        
                        // Renderiza Logs Internos da OS
                        let logsHtml = '<ul class="list-group list-group-flush small mb-3">';
                        if(os.logs && os.logs.length > 0) {
                            os.logs.forEach(log => {
                                logsHtml += `
                                    <li class="list-group-item bg-transparent px-0 border-bottom py-2">
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-bold text-primary">${log.titulo}</span>
                                            <span class="text-muted" style="font-size:0.75rem">${log.data}</span>
                                        </div>
                                        <div class="text-dark">${log.obs}</div>
                                    </li>
                                `;
                            });
                        } else {
                            logsHtml += '<li class="list-group-item bg-transparent px-0 text-muted fst-italic">Aguardando registros técnicos...</li>';
                        }
                        logsHtml += '</ul>';

                        let itemHtml = `
                            <div class="accordion-item mb-2 border shadow-sm" style="border-radius: 6px; overflow: hidden;">
                                <h2 class="accordion-header">
                                    <button class="accordion-button ${index !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#osCollapse${index}">
                                        <div class="d-flex w-100 justify-content-between me-3 align-items-center">
                                            <span><strong>O.S. #${os.numero}</strong> <span class="text-muted ms-2 small">(${os.inicio})</span></span>
                                            ${badge}
                                        </div>
                                    </button>
                                </h2>
                                <div id="osCollapse${index}" class="accordion-collapse collapse ${collapseShow}" data-bs-parent="#accordionManutencoes">
                                    <div class="accordion-body bg-light">
                                        <div class="alert alert-warning bg-opacity-10 border-warning small mb-3 text-dark">
                                            <strong>Motivo da Abertura:</strong> ${os.motivo}
                                        </div>
                                        <h6 class="text-muted small fw-bold text-uppercase border-bottom pb-2 mb-2">Diário Técnico</h6>
                                        ${logsHtml}
                                        ${os.fim ? `<div class="text-end small fw-bold text-success mt-2 pt-2 border-top">Encerrada em: ${os.fim}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        listaManut.innerHTML += itemHtml;
                    });
                }

                // C. Renderizar Insumos
                listaInsumos.innerHTML = '';
                if (!data.insumos || data.insumos.length === 0) {
                    listaInsumos.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-4">Nenhum insumo enviado para esta máquina.</td></tr>';
                } else {
                    data.insumos.forEach(i => {
                        listaInsumos.innerHTML += `
                            <tr>
                                <td class="text-muted ps-3">${i.data}</td>
                                <td>
                                    <div class="fw-bold text-dark">${i.produto}</div>
                                    <small class="text-muted">${i.marca}</small>
                                </td>
                                <td class="text-center fw-bold text-primary">${i.qtd}</td>
                                <td class="text-end pe-3 text-muted small">#${i.pedido}</td>
                            </tr>
                        `;
                    });
                }
            })
            .catch(err => {
                console.error(err);
                timeline.innerHTML = '<div class="alert alert-danger m-3">Erro ao carregar dados.</div>';
            });
    }
</script>
{% endblock %}