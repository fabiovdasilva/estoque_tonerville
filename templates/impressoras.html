{% extends "base.html" %}

{% block content %}
<style>
    .page-title { color: #2C3E50 !important; font-family: 'Segoe UI', sans-serif; font-weight: 700; margin-bottom: 5px; }
    
    /* Cards */
    .card-overview { border: none; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); color: white; position: relative; overflow: hidden; }
    .bg-gradient-info { background: linear-gradient(135deg, #3498db, #2980b9); }
    .bg-gradient-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-gradient-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .bg-gradient-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }

    /* Tabela */
    .table thead th { 
        background-color: #f8f9fa; color: #6c757d; font-weight: 700; font-size: 0.8rem; 
        border-bottom: 2px solid #e9ecef; border-top: none; padding: 12px 15px; 
        text-transform: uppercase; letter-spacing: 0.5px; 
    }
    .table tbody td { vertical-align: middle; color: #495057; font-size: 0.9rem; padding: 12px 15px; border-bottom: 1px solid #f5f5f5; }
    
    /* Status Badge */
    .badge-status { padding: 5px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .status-disp { background-color: rgba(39, 174, 96, 0.1); color: #27ae60; border: 1px solid rgba(39, 174, 96, 0.2); }
    .status-loc { background-color: rgba(52, 152, 219, 0.1); color: #2980b9; border: 1px solid rgba(52, 152, 219, 0.2); }
    .status-manut { background-color: rgba(243, 156, 18, 0.1); color: #d35400; border: 1px solid rgba(243, 156, 18, 0.2); }

    .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #adb5bd; margin-bottom: 10px; display: block; letter-spacing: 0.5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
</style>

<div id="impressoras-page" class="page-content active">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Impressoras</h1>
                <p class="page-subtitle mb-0">Gestão de parque e status</p>
            </div>
            <div>
                <button class="btn btn-primary btn-action shadow-sm me-2" onclick="abrirModalNova()">
                    <i class="fas fa-plus me-2"></i> Nova Impressora
                </button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card card-overview bg-gradient-info p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ total }}</h3><small>Total Máquinas</small></div>
                    <i class="fas fa-print fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-overview bg-gradient-success p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ disponiveis }}</h3><small>Disponíveis</small></div>
                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-overview bg-gradient-warning p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ locadas }}</h3><small>Locadas</small></div>
                    <i class="fas fa-truck-loading fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-overview bg-gradient-danger p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h3>{{ manutencao }}</h3><small>Em Manutenção</small></div>
                    <i class="fas fa-tools fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <form method="GET" action="{{ url_for('impressoras') }}" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Buscar</label>
                    <input type="text" class="form-control" name="busca" placeholder="Modelo, Serial ou Local..." value="{{ request.args.get('busca', '') }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Status</label>
                    <select class="form-select" name="status">
                        <option value="Todas">Todos</option>
                        <option value="Disponível" {% if request.args.get('status') == 'Disponível' %}selected{% endif %}>Disponível</option>
                        <option value="Locada" {% if request.args.get('status') == 'Locada' %}selected{% endif %}>Locada</option>
                        <option value="Manutenção" {% if request.args.get('status') == 'Manutenção' %}selected{% endif %}>Manutenção</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Cliente (Local)</label>
                    <select class="form-select" name="cliente_id">
                        <option value="Todos">Todos</option>
                        {% for c in clientes %}
                            <option value="{{ c.id }}" {% if request.args.get('cliente_id') == c.id|string %}selected{% endif %}>{{ c.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-primary w-100 fw-bold"><i class="fas fa-filter me-2"></i>Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead>
                        <tr>
                            <th class="ps-4">Modelo / Serial</th>
                            <th>Status</th>
                            <th>Localização</th>
                            <th>Contador</th>
                            <th class="text-end pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for imp in impressoras %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">{{ imp.modelo }}</div>
                                <div class="text-muted small">
                                    <span class="me-2"><i class="fas fa-barcode me-1"></i> {{ imp.serial }}</span>
                                    {% if imp.mlt %}<span class="me-2 text-primary">| MLT: {{ imp.mlt }}</span>{% endif %}
                                </div>
                                {% if imp.observacao %}
                                    <div class="text-muted small fst-italic mt-1"><i class="fas fa-info-circle me-1"></i> {{ imp.observacao }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if imp.status == 'Disponível' %} <span class="badge-status status-disp">Disponível</span>
                                {% elif imp.status == 'Locada' %} <span class="badge-status status-loc">Locada</span>
                                {% else %} <span class="badge-status status-manut">Manutenção</span> {% endif %}
                            </td>
                            <td><i class="fas fa-map-marker-alt text-muted me-1"></i> {{ imp.localizacao }}</td>
                            <td class="fw-bold">{{ imp.contador }}</td>
                            <td class="text-end pe-4">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="abrirHistorico('{{ imp.id }}')" title="Histórico"><i class="fas fa-history"></i></button>
                                    <button class="btn btn-sm btn-outline-dark" onclick="abrirMovimentacao('{{ imp.id }}', '{{ imp.modelo }}', '{{ imp.contador }}', '{{ imp.status }}')" title="Movimentar"><i class="fas fa-exchange-alt"></i></button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="abrirEdicao('{{ imp.id }}', '{{ imp.marca }}', '{{ imp.modelo }}', '{{ imp.serial }}', '{{ imp.mlt }}', '{{ imp.observacao }}')" title="Editar"><i class="fas fa-edit"></i></button>
                                    <a href="{{ url_for('excluir_impressora', id=imp.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Excluir esta impressora?')" title="Excluir"><i class="fas fa-trash"></i></a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center p-5 text-muted">Nenhuma impressora encontrada.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovaImpressora" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Nova Impressora</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('criar_impressora') }}" method="POST">
                <div class="modal-body bg-light">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body">
                            <span class="section-title">Identificação do Equipamento</span>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">Marca</label>
                                    <select class="form-select" name="marca" required>
                                        <option value="" disabled selected>Selecione...</option>
                                        <option value="Kyocera">Kyocera</option>
                                        <option value="Epson">Epson</option>
                                        <option value="Canon">Canon</option>
                                        <option value="HP">HP</option>
                                        <option value="Samsung">Samsung</option>
                                        <option value="Ricoh">Ricoh</option>
                                        <option value="Brother">Brother</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small fw-bold text-muted">Modelo</label>
                                    <input type="text" class="form-control" name="modelo" placeholder="Ex: M420dn (O sistema salvará como 'Brother M420dn')" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">Serial Number (S/N)</label>
                                    <input type="text" class="form-control" name="serial" placeholder="Número de Série único" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">Contador Inicial</label>
                                    <input type="number" class="form-control" name="contador" value="0">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold text-muted">Tecnologia / MLT</label>
                                    <input type="text" class="form-control" name="mlt" placeholder="Ex: Laser Mono, MLT-D111S, etc...">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <span class="section-title">Observações</span>
                            <textarea class="form-control border-0 bg-light" name="observacao" rows="2" placeholder="Detalhes adicionais..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">Cadastrar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMovimentacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Movimentar Equipamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('movimentar_impressora') }}" method="POST">
                <input type="hidden" name="impressora_id" id="mov_id">
                <div class="modal-body">
                    <div class="alert alert-light border text-center mb-3">
                        <strong id="mov_titulo" class="text-dark"></strong>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Tipo de Movimento</label>
                        <select class="form-select" name="tipo_movimentacao" id="selectTipoMov" onchange="toggleClienteMov()" required>
                            <option value="Locação">Enviar para Locação (Cliente)</option>
                            <option value="Devolução">Devolver ao Estoque (Vindo de Cliente)</option>
                            <option value="Manutenção" class="text-danger fw-bold">Enviar para Manutenção</option>
                            <option value="Disponibilizar" class="text-success fw-bold">Finalizar Manutenção (Voltar p/ Estoque)</option>
                        </select>
                    </div>

                    <div class="mb-3" id="divClienteMov">
                        <label class="form-label small fw-bold">Cliente Destino</label>
                        <select class="form-select" name="cliente_id">
                            <option value="">Selecione...</option>
                            {% for c in clientes %}
                            <option value="{{ c.id }}">{{ c.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Contador Atual</label>
                        <input type="number" class="form-control" name="contador_atual" id="mov_contador" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Observação / Motivo</label>
                        <textarea class="form-control" name="observacao" rows="2" placeholder="Motivo da manutenção ou obs de locação..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark w-100 fw-bold">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="modalEditarImpressora" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title text-primary"><i class="fas fa-edit me-2"></i>Editar Impressora</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('editar_impressora') }}" method="POST">
                <input type="hidden" name="impressora_id" id="edit_imp_id">
                <div class="modal-body bg-light">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted">Marca</label>
                                    <select class="form-select" name="marca" id="edit_marca" required>
                                        <option value="Kyocera">Kyocera</option>
                                        <option value="Epson">Epson</option>
                                        <option value="Canon">Canon</option>
                                        <option value="HP">HP</option>
                                        <option value="Samsung">Samsung</option>
                                        <option value="Ricoh">Ricoh</option>
                                        <option value="Brother">Brother</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small fw-bold text-muted">Modelo (Sem a marca)</label>
                                    <input type="text" class="form-control" name="modelo" id="edit_modelo" required>
                                </div>
                                <div class="col-md-6"><label class="form-label small fw-bold text-muted">Serial</label><input type="text" class="form-control" name="serial" id="edit_serial"></div>
                                <div class="col-md-6"><label class="form-label small fw-bold text-muted">MLT</label><input type="text" class="form-control" name="mlt" id="edit_mlt"></div>
                                <div class="col-12"><label class="form-label small fw-bold text-muted">Obs</label><textarea class="form-control" name="observacao" id="edit_obs"></textarea></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-light"><button type="submit" class="btn btn-primary">Salvar Alterações</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistorico" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-white border-bottom pb-0">
                <div>
                    <h5 class="modal-title fw-bold text-dark" id="hist_titulo_modal">Histórico do Equipamento</h5>
                    <p class="text-muted small mb-2">Visão completa do ciclo de vida</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="bg-white px-3">
                <ul class="nav nav-tabs nav-justified" id="histTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-mov" type="button">
                            <i class="fas fa-exchange-alt me-2 text-primary"></i>Movimentações
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-manut" type="button">
                            <i class="fas fa-tools me-2 text-danger"></i>Manutenções (O.S.)
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-insumos" type="button">
                            <i class="fas fa-box-open me-2 text-success"></i>Insumos Enviados
                        </button>
                    </li>
                </ul>
            </div>

            <div class="modal-body bg-light p-3">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-mov">
                        <ul class="list-group list-group-flush rounded shadow-sm" id="lista_movimentacoes">
                            </ul>
                    </div>

                    <div class="tab-pane fade" id="tab-manut">
                        
                        <div class="card border-warning mb-3 shadow-sm">
                            <div class="card-header bg-warning bg-opacity-10 border-warning d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-dark"><i class="fas fa-plus-circle me-1"></i> Adicionar Registro na O.S.</span>
                                <button class="btn btn-sm btn-light text-dark border" type="button" data-bs-toggle="collapse" data-bs-target="#formLogManutencao">
                                    Expandir
                                </button>
                            </div>
                            <div class="collapse show" id="formLogManutencao">
                                <div class="card-body bg-white">
                                    <form action="{{ url_for('adicionar_log_manutencao') }}" method="POST">
                                        <input type="hidden" name="impressora_id" id="hist_form_imp_id">
                                        <input type="hidden" name="manutencao_id" id="hist_form_manut_id"> <div class="row g-2">
                                            <div class="col-md-4">
                                                <label class="small fw-bold text-muted">Ação / Título</label>
                                                <select class="form-select form-select-sm" name="status_detalhe">
                                                    <option value="Diagnóstico Técnico">Diagnóstico Técnico</option>
                                                    <option value="Troca de Peça">Troca de Peça</option>
                                                    <option value="Limpeza">Limpeza</option>
                                                    <option value="Aguardando Peça">Aguardando Peça</option>
                                                    <option value="Teste Final">Teste Final</option>
                                                    <option value="Observação">Observação Geral</option>
                                                </select>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="small fw-bold text-muted">Descrição</label>
                                                <input type="text" class="form-control form-control-sm" name="observacao" placeholder="Ex: Trocado rolete de fusão..." required>
                                            </div>
                                            <div class="col-12 text-end mt-2">
                                                <button type="submit" class="btn btn-sm btn-warning text-dark fw-bold">
                                                    <i class="fas fa-save me-1"></i> Salvar no Histórico
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="accordion shadow-sm" id="accordionManutencoes">
                            </div>
                    </div>

                    <div class="tab-pane fade" id="tab-insumos">
                        <div class="card border-0 shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 small align-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-3">Data</th>
                                            <th>Item Enviado</th>
                                            <th class="text-center">Qtd</th>
                                            <th class="text-end pe-3">Pedido</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaInsumosImpressora">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    // Inicialização dos Modais
    var modalNova = new bootstrap.Modal(document.getElementById('modalNovaImpressora'));
    var modalMov = new bootstrap.Modal(document.getElementById('modalMovimentacao'));
    var modalEdit = new bootstrap.Modal(document.getElementById('modalEditarImpressora'));
    var modalHist = new bootstrap.Modal(document.getElementById('modalHistorico'));

    function abrirModalNova() {
        modalNova.show();
    }

  function abrirMovimentacao(id, modelo, contador, statusAtual) {
        document.getElementById('mov_id').value = id;
        document.getElementById('mov_titulo').innerText = modelo;
        document.getElementById('mov_contador').value = contador;
        
        var select = document.getElementById('selectTipoMov');
        
        // Lógica automática para facilitar
        if(statusAtual === 'Disponível') {
            // Se está no estoque, sugere Locação, mas permite Manutenção
            select.value = 'Locação'; 
        } else if(statusAtual === 'Locada') {
            // Se está no cliente, sugere Devolução
            select.value = 'Devolução';
        } else if(statusAtual === 'Manutenção') {
            // Se está em manutenção, sugere Finalizar (Disponibilizar)
            select.value = 'Disponibilizar';
        }
        
        toggleClienteMov(); // Ajusta visibilidade do cliente
        modalMov.show();
    }

    function toggleClienteMov() {
        var tipo = document.getElementById('selectTipoMov').value;
        var div = document.getElementById('divClienteMov');
        
        // Só mostra o campo Cliente se for LOCAÇÃO
        if (tipo === 'Locação') {
            div.style.display = 'block';
            // Adiciona required para evitar erro
            div.querySelector('select').setAttribute('required', 'required');
        } else {
            div.style.display = 'none';
            // Remove required para não travar o formulário
            div.querySelector('select').removeAttribute('required');
        }
    }


    function abrirEdicao(id, marca, modeloFull, serial, mlt, obs) {
        document.getElementById('edit_imp_id').value = id;
        
        // Tenta separar a marca do modelo se o modeloFull vier como "Brother M420dn"
        // Se a marca já estiver correta no banco, usamos ela.
        document.getElementById('edit_marca').value = marca;
        
        // Remove a marca do texto do modelo para exibição limpa no input
        let modeloLimpo = modeloFull.replace(marca, '').trim();
        document.getElementById('edit_modelo').value = modeloLimpo;
        
        document.getElementById('edit_serial').value = serial;
        document.getElementById('edit_mlt').value = mlt;
        document.getElementById('edit_obs').value = obs;
        modalEdit.show();
    }

function abrirHistorico(id) {
        // Prepara IDs para o formulário de log
        document.getElementById('hist_form_imp_id').value = id;
        document.getElementById('hist_form_manut_id').value = ""; // Reseta, deixa o backend buscar a aberta
        
        // Elementos da UI
        var listaMov = document.getElementById('lista_movimentacoes');
        var listaManut = document.getElementById('accordionManutencoes');
        var listaInsumos = document.getElementById('tabelaInsumosImpressora');
        
        // Loading State
        listaMov.innerHTML = '<li class="list-group-item text-center p-4"><div class="spinner-border text-primary"></div></li>';
        listaManut.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-danger"></div></div>';
        listaInsumos.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="spinner-border text-success"></div></td></tr>';
        
        modalHist.show();

        // Fetch Completo
        fetch('/api/historico_completo/' + id)
            .then(response => response.json())
            .then(data => {
                // 1. Preencher Movimentações
                listaMov.innerHTML = '';
                if (!data.movimentacoes || data.movimentacoes.length === 0) {
                    listaMov.innerHTML = '<li class="list-group-item text-center text-muted">Sem movimentações registradas.</li>';
                } else {
                    data.movimentacoes.forEach(m => {
                        let html = `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold text-primary">${m.tipo}</span>
                                    <small class="text-muted">${m.data}</small>
                                </div>
                                <div class="small mt-1">
                                    <i class="fas fa-map-marker-alt text-muted me-1"></i> ${m.origem} &rarr; <strong>${m.destino}</strong>
                                </div>
                                ${m.obs ? `<div class="small text-muted fst-italic mt-1 border-top pt-1">${m.obs}</div>` : ''}
                            </li>
                        `;
                        listaMov.innerHTML += html;
                    });
                }

                // 2. Preencher Manutenções (Accordion)
                listaManut.innerHTML = '';
                if (!data.manutencoes || data.manutencoes.length === 0) {
                    listaManut.innerHTML = '<div class="alert alert-light text-center border">Nenhuma Ordem de Serviço encontrada.</div>';
                } else {
                    data.manutencoes.forEach((os, index) => {
                        let isOpen = os.status === 'Aberta';
                        let badge = isOpen ? '<span class="badge bg-warning text-dark">ABERTA</span>' : '<span class="badge bg-secondary">FECHADA</span>';
                        let borderClass = isOpen ? 'border-warning' : '';
                        let collapseShow = index === 0 ? 'show' : ''; // Abre a primeira (mais recente)
                        
                        // Renderiza os logs internos da OS
                        let logsHtml = '<ul class="list-unstyled mb-0 small">';
                        if(os.logs && os.logs.length > 0) {
                            os.logs.forEach(log => {
                                logsHtml += `
                                    <li class="mb-2 border-bottom pb-2">
                                        <div class="d-flex justify-content-between">
                                            <strong class="text-dark">${log.titulo}</strong>
                                            <span class="text-muted" style="font-size:0.75rem">${log.data}</span>
                                        </div>
                                        <div class="text-muted">${log.obs}</div>
                                    </li>
                                `;
                            });
                        } else {
                            logsHtml += '<li class="text-muted fst-italic">Sem registros técnicos.</li>';
                        }
                        logsHtml += '</ul>';

                        let itemHtml = `
                            <div class="accordion-item ${borderClass}">
                                <h2 class="accordion-header">
                                    <button class="accordion-button ${index !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#osCollapse${index}">
                                        <div class="d-flex w-100 justify-content-between me-3 align-items-center">
                                            <span><strong>O.S. #${os.numero}</strong> <span class="ms-2 text-muted" style="font-size:0.8rem">(${os.inicio})</span></span>
                                            ${badge}
                                        </div>
                                    </button>
                                </h2>
                                <div id="osCollapse${index}" class="accordion-collapse collapse ${collapseShow}" data-bs-parent="#accordionManutencoes">
                                    <div class="accordion-body bg-light">
                                        <div class="mb-2"><strong>Motivo Inicial:</strong> ${os.motivo}</div>
                                        <div class="card card-body border-0 shadow-sm">
                                            <h6 class="text-muted border-bottom pb-2 mb-2 text-uppercase" style="font-size:0.7rem">Histórico Técnico</h6>
                                            ${logsHtml}
                                        </div>
                                        ${os.fim ? `<div class="mt-2 text-end small fw-bold text-success">Encerrada em: ${os.fim}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        listaManut.innerHTML += itemHtml;
                    });
                }

                // 3. Preencher Insumos
                listaInsumos.innerHTML = '';
                if (!data.insumos || data.insumos.length === 0) {
                    listaInsumos.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-4">Nenhum insumo enviado para esta máquina.</td></tr>';
                } else {
                    data.insumos.forEach(i => {
                        listaInsumos.innerHTML += `
                            <tr>
                                <td class="ps-3 text-muted">${i.data}</td>
                                <td>
                                    <div class="fw-bold text-dark">${i.produto}</div>
                                    <small class="text-muted">${i.marca}</small>
                                </td>
                                <td class="text-center fw-bold text-primary">${i.qtd}</td>
                                <td class="text-end pe-3 small text-muted">#${i.pedido}</td>
                            </tr>
                        `;
                    });
                }
            })
            .catch(err => {
                console.error(err);
                listaMov.innerHTML = '<div class="alert alert-danger m-3">Erro ao carregar dados.</div>';
            });
    }


</script>
{% endblock %}